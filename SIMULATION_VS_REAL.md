# AMM 模擬與真實實盤差異說明

本文檔詳細說明本回測系統模擬的 AMM 行為與真實 Uniswap V3 實盤之間的差異。

## 概述

本回測系統基於歷史事件數據（Mint、Burn、Swap）模擬 Uniswap V3 風格的 AMM 池行為，但由於模擬環境的限制，存在以下主要差異：

---

## 1. 手續費處理差異

### 實盤情況
- **手續費累積**：每次 Swap 會產生 0.3% 的手續費，這些手續費會累積在池子中
- **手續費分配**：手續費按 LP 提供的流動性比例分配給 LP
- **手續費複利**：手續費會自動再投資到池子中，產生複利效果
- **feeGrowthGlobal**：Uniswap V3 使用 `feeGrowthGlobal0` 和 `feeGrowthGlobal1` 追蹤累積手續費

### 模擬情況（已改進）
- **手續費累積機制**：✅ 已實現 `feeGrowthGlobal0` 和 `feeGrowthGlobal1` 的累積
- **手續費分配**：✅ 已實現按 LP 流動性比例分配手續費給各個位置
- **手續費追蹤**：✅ 每個 LP 位置追蹤 `tokens_owed0` 和 `tokens_owed1`
- **手續費計算**：✅ 從 Swap 交易金額中計算 0.3% 手續費
- **手續費收入指標**：✅ `total_fees_earned` 正確計算累積手續費收入（以 USDC 計價）
- **⚠️ 簡化部分**：
  - `feeGrowthInside` 計算使用簡化版本（未完整實現 tick 的 `feeGrowthOutside`）
  - 手續費只在價格在 LP 範圍內時累積（簡化處理）
  - 未考慮手續費自動再投資的複利效果

### 影響
- **基本準確**：手續費處理已基本實現，對於價格在 LP 範圍內的情況較準確
- **邊界情況**：當價格在 LP 範圍外時，手續費計算可能不夠精確
- **複利效應**：未考慮手續費自動再投資，長期可能略有差異

---

## 2. 價格計算精度差異

### 實盤情況
- **高精度計算**：Uniswap V3 使用 256 位整數和 Q64.96 定點數進行高精度計算
- **sqrtPriceX96**：使用 `sqrtPriceX96` 格式存儲價格，避免精度損失
- **tick 系統**：價格範圍劃分為 ticks，每個 tick 對應固定價格間隔（1.0001^tick）

### 模擬情況
- **簡化計算**：雖然使用了 Decimal 高精度，但在某些計算中仍使用浮點數
- **價格轉換**：`sqrtPriceX96` 到實際價格的轉換可能存在精度損失
- **tick 計算**：tick 與價格的轉換使用對數計算，可能存在舍入誤差

### 影響
- **小額差異**：對於大額交易，精度差異可能累積
- **邊界情況**：在價格接近 tick 邊界時，可能出現計算偏差

---

## 3. 流動性計算差異

### 實盤情況
- **集中流動性**：Uniswap V3 使用集中流動性模型，LP 在特定價格區間提供流動性
- **流動性聚合**：同一 tick 範圍內的多個位置會聚合流動性
- **虛擬流動性**：使用虛擬流動性（virtual liquidity）概念來計算價格影響

### 模擬情況
- **簡化模型**：流動性計算使用簡化公式，可能不完全符合 Uniswap V3 的實際算法
- **位置聚合**：雖然追蹤了多個 LP 位置，但聚合計算可能不完整
- **價格影響**：大額交易的價格影響計算可能不夠精確

### 影響
- **大額交易偏差**：對於大額 Swap，模擬的價格影響可能與實盤不同
- **流動性效率**：流動性效率指標可能不夠準確

---

## 4. 無常損失計算差異

### 實盤情況
- **動態計算**：無常損失隨價格變化實時計算
- **複合效應**：考慮手續費收入對無常損失的抵消作用
- **時間加權**：實際無常損失是時間加權的平均值

### 模擬情況
- **簡化計算**：使用簡化的無常損失公式
- **靜態比較**：主要比較初始價值與當前價值，未考慮動態變化
- **手續費抵消**：未完整考慮手續費收入對無常損失的抵消

### 影響
- **高估無常損失**：可能高估無常損失，因為未考慮手續費抵消
- **時間效應**：長期持有的無常損失計算可能不夠準確

---

## 5. Gas 費用和交易成本

### 實盤情況
- **Gas 費用**：每次 Mint、Burn、Swap 都需要支付 Gas 費用
- **Gas 價格波動**：Gas 價格會隨網絡擁堵程度波動
- **交易成本**：實際收益需要扣除所有交易成本

### 模擬情況
- **未考慮 Gas**：模擬中完全未考慮 Gas 費用
- **零交易成本**：假設所有操作無成本執行

### 影響
- **高估收益**：實際收益會低於模擬結果，特別是對於頻繁操作的小額 LP
- **策略偏差**：可能導致某些策略在模擬中表現良好，但實盤因 Gas 成本而虧損

---

## 6. 滑點和價格影響

### 實盤情況
- **即時滑點**：大額交易會產生即時價格影響（滑點）
- **MEV 攻擊**：可能面臨搶跑（front-running）和夾子（sandwich）攻擊
- **價格發現**：價格是通過市場供需動態發現的

### 模擬情況
- **使用歷史價格**：直接使用歷史事件中的價格，未模擬滑點
- **無 MEV 風險**：假設所有交易按預期價格執行
- **完美執行**：假設可以完美執行所有交易

### 影響
- **低估成本**：實際交易成本可能高於模擬
- **高估執行效率**：模擬中的執行效率可能優於實盤

---

## 7. 時間和執行延遲

### 實盤情況
- **區塊時間**：交易需要等待區塊確認（約 12 秒）
- **執行延遲**：從提交交易到執行完成存在延遲
- **時機選擇**：無法在精確的價格點執行交易

### 模擬情況
- **即時執行**：假設所有交易可以即時執行
- **完美時機**：可以使用歷史數據中的精確價格
- **無延遲**：沒有執行延遲

### 影響
- **高估收益**：實際可能無法在最佳時機執行交易
- **時機偏差**：模擬中的進出場時機可能優於實盤

---

## 8. 流動性深度和價格衝擊

### 實盤情況
- **流動性深度**：實際池子的流動性深度可能與歷史不同
- **價格衝擊**：大額交易會對價格產生衝擊
- **流動性變化**：流動性會隨 LP 的添加和移除動態變化

### 模擬情況
- **歷史流動性**：使用歷史事件中的流動性數據
- **已知價格**：使用已知的歷史價格，未模擬價格衝擊
- **靜態假設**：假設流動性深度已知且穩定

### 影響
- **低估價格影響**：大額交易的實際價格影響可能更大
- **流動性假設**：假設可以按歷史流動性執行，但實盤可能不同

---

## 9. 數據完整性和準確性

### 實盤情況
- **完整數據**：區塊鏈上記錄了所有交易和狀態變化
- **不可篡改**：數據一旦上鏈就不可篡改
- **實時更新**：狀態實時更新

### 模擬情況
- **數據依賴**：完全依賴提供的歷史事件數據
- **數據質量**：取決於數據的完整性和準確性
- **缺失事件**：如果數據中缺少某些事件，模擬結果會受影響

### 影響
- **數據偏差**：如果歷史數據不完整，模擬結果會有偏差
- **重構誤差**：無法完全重構歷史狀態

---

## 10. 其他限制

### 未實現的功能
- **多池套利**：未考慮跨池套利機會
- **閃電貸**：未模擬閃電貸等複雜操作
- **治理代幣**：未考慮 UNI 代幣等治理代幣的價值
- **協議升級**：未考慮協議升級對池子的影響

### 簡化假設
- **單一池子**：只模擬單一池子，未考慮多池策略
- **被動策略**：主要模擬被動 LP 策略，未考慮主動管理
- **無風險管理**：未考慮風險管理措施（如止損）

---

## 總結

### 主要差異影響

| 差異類型 | 對收益的影響 | 嚴重程度 |
|---------|------------|---------|
| 手續費處理 | 基本準確（已改進） | 中 |
| Gas 費用 | 高估收益 | 高 |
| 價格精度 | 小額偏差 | 中 |
| 滑點和 MEV | 高估收益 | 中 |
| 執行延遲 | 高估收益 | 中 |
| 無常損失計算 | 可能高估 | 中 |
| 流動性計算 | 大額交易偏差 | 中 |

### 建議

1. **保守估計**：將模擬結果視為理想情況，實際收益可能更低
2. **考慮成本**：在模擬結果基礎上扣除 Gas 費用（約 0.1-0.5%）
3. **滑點調整**：對於大額交易，考慮 0.1-0.3% 的滑點成本
4. **手續費驗證**：需要驗證手續費計算的準確性
5. **實盤測試**：在實盤小額測試後再擴大規模

### 適用場景

本回測系統適用於：
- ✅ 策略驗證和初步評估
- ✅ 理解 AMM 機制和 LP 行為
- ✅ 歷史數據分析和學習
- ✅ 相對績效比較（不同策略之間）

不適用於：
- ❌ 精確的收益預測
- ❌ 實盤交易的直接決策
- ❌ 需要高精度計算的場景
- ❌ 考慮複雜 MEV 攻擊的場景

---

## 未來改進方向

1. **完整手續費機制**：✅ 已實現基本手續費處理，可進一步完善 `feeGrowthOutside` 計算
2. **Gas 費用模擬**：加入 Gas 費用計算
3. **滑點模擬**：根據交易大小模擬滑點
4. **精度提升**：使用更高精度的數值計算
5. **MEV 模擬**：模擬搶跑和夾子攻擊
6. **多池支持**：支持跨池套利策略
7. **實時數據**：支持連接實時數據源

---

**最後更新**：2025-01-XX  
**版本**：1.0.0

