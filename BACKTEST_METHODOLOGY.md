# 回測方法論說明

## 當前回測系統的工作原理

### ✅ 使用真實歷史數據

**是的，系統確實使用真實的歷史幣價和交易量數據進行回測。**

1. **數據來源**：
   - 從 `wbtc_usdc_pool_events.jsonl` 讀取真實的鏈上事件
   - 包含真實的 Swap、Mint、Burn 事件
   - 每個事件包含真實的 `sqrtPriceX96`、`tick`、`liquidity`、`amount0`、`amount1` 等數據

2. **價格追蹤**：
   - 從每個 Swap 事件的 `sqrtPriceX96` 和 `tick` 提取真實價格
   - 價格歷史完全基於鏈上實際交易價格
   - 不是模擬或預測，而是真實歷史價格

3. **交易量追蹤**：
   - 從 Swap 事件的 `amount0` 和 `amount1` 提取真實交易量
   - 手續費計算基於真實的交易量
   - 累積的手續費來自真實的交易活動

### ⚠️ 當前問題

**雖然使用了真實數據，但回測結果不合理的原因：**

1. **初始位置創建失敗**：
   - 流動性計算返回 0
   - 導致無法創建 LP 位置
   - 因此沒有手續費收入

2. **價格範圍計算錯誤**：
   - `_tick_to_price` 返回的價格需要正確的縮放
   - 當前計算可能導致價格範圍為 0

3. **手續費計算可能不準確**：
   - 雖然使用了真實交易量，但手續費累積邏輯可能有問題
   - 需要驗證手續費是否正確分配到 LP 位置

### 🔧 需要修復的問題

1. **修復價格範圍計算**：
   - 正確處理 tick 到價格的轉換
   - 考慮 WBTC (8 decimals) 和 USDC (6 decimals) 的差異

2. **修復流動性計算**：
   - 確保 `get_liquidity_from_amounts` 返回正確的流動性值
   - 檢查初始資金分配邏輯

3. **驗證手續費計算**：
   - 確認手續費是否正確從 Swap 事件中提取
   - 確認手續費是否正確分配到 LP 位置

### 📊 回測流程

```
1. 讀取 JSONL 文件中的真實事件
   ↓
2. 按時間順序處理每個事件
   ↓
3. Swap 事件 → 更新池子價格和流動性（真實價格）
   ↓
4. 計算手續費並分配到 LP 位置（基於真實交易量）
   ↓
5. Mint/Burn 事件 → 更新 LP 位置（如果追蹤）
   ↓
6. 定期計算投資組合價值
   ↓
7. 生成績效報告
```

### ✅ 真實性保證

- ✅ **價格**：完全基於鏈上真實價格
- ✅ **交易量**：完全基於鏈上真實交易量
- ✅ **手續費**：基於真實交易量計算
- ⚠️ **流動性深度**：使用事件中的 `liquidity` 字段，但可能不完整
- ⚠️ **Slippage**：目前未模擬，假設按當前價格成交

### 🎯 改進方向

1. **添加 Slippage 模擬**：
   - 根據當前流動性深度計算實際成交價格
   - 大額交易會影響價格

2. **驗證數據完整性**：
   - 確保所有必要的事件都被處理
   - 檢查價格和流動性數據的一致性

3. **添加數據驗證**：
   - 檢查價格是否合理
   - 檢查交易量是否合理
   - 檢查流動性是否合理

## 總結

**系統確實使用真實歷史數據進行回測**，但當前存在以下問題：

1. 初始位置創建失敗（流動性為 0）
2. 價格範圍計算錯誤
3. 手續費可能沒有正確累積

修復這些問題後，回測結果應該會更合理。

